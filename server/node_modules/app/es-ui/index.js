'use strict';

/**
 * Module dependencies
 */

/**
 * Core libs
 */
const path = require('path');

/**
 * Third party libs
 */
const koa = require('koa');
const hbs = require('koa-hbs');
const route = require('koa-route');
const serve = require('koa-static');

/**
 * Local libs
 */
var elastic = require('./model');

/**
 * Application
 */
var app = koa();

module.exports = conf => {
  elastic = elastic(conf);
  return app;
};

/**
 * Statics
 */
app.use(serve(path.resolve(__dirname, './static')));

/**
 * Koa view
 */
app.use(hbs.middleware({
  viewPath: path.resolve(__dirname, './views')
}));

app.use(function*(next) {
  var tmpRender = this.render;
  var self = this;
  this.render = function*() {
    // Replace Array.prototype.slice.call with es6 asa it hits v8.
    var args = Array.prototype.slice.call(arguments);
    var parentPath = {
      'parent': this.mountPath
    };
    Object.assign(args[1], parentPath);
    yield tmpRender.apply(self, args);
  };
  yield next;
});

var index = function*() {
  var result = yield elastic.home;
  yield* this.render('index', {
    data: result
  });
};

app.use(route.get('/', index));
